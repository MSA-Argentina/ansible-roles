---
  - name: Adding repo key
    apt_key:
      url=http://nginx.org/keys/nginx_signing.key
      state=present
    when: ansible_distribution == 'Ubuntu' and ansible_distribution_release != 'xenial'
    
  - name: Adding nginx repository
    apt_repository:
      repo="{{nginx_repository}}"
      update_cache=yes
      state=present
    when: ansible_distribution == 'Ubuntu' and ansible_distribution_release != 'xenial'

  - name: Installing nginx
    apt:
      pkg=nginx

  - name: Creating ssl dir
    file:
      path=/etc/nginx/ssl
      state=directory
      owner=root
      mode=770

  - name: Creating sites-available dir
    file:
      path=/etc/nginx/sites-available
      state=directory
      owner=root
      mode=770

  - name: Creating sites-enabled dir
    file:
      path=/etc/nginx/sites-enabled
      state=directory
      owner=root
      mode=770

  - name: Copying nginx.conf
    template:
      src=nginx.conf.j2
      dest=/etc/nginx/nginx.conf
      backup=yes
      owner=root
      mode=0644

  - name: Deleting default conf file
    file:
      path=/etc/nginx/conf.d/default.conf
      state=absent

  - name: Adding security config to conf.d
    template:
      src=security.conf.j2
      dest=/etc/nginx/conf.d/security.conf
      backup=yes
      owner=root
      mode=0644

  - name: Adding gzip config to conf.d
    template:
      src=gzip.conf.j2
      dest=/etc/nginx/conf.d/gzip.conf
      backup=yes
      owner=root
      mode=0644
    notify:
      - restart nginx
